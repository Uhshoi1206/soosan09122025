---
/**
 * BlogLayout.astro
 * Extended layout for blog/article pages with Article Schema.org support
 */
import '../styles/global.css';
import '../components/blog/BlogStyles.css';
import FloatingWidgets from '../components/FloatingWidgets';
import GlobalSearch from '../components/GlobalSearch.astro';
import SocialMeta from '../components/seo/SocialMeta.astro';
import ArticleSchema from '../components/seo/ArticleSchema.astro';
import { getCollection } from 'astro:content';

interface Props {
  article: {
    id: string;
    title: string;
    slug: string;
    description: string;
    category: string;
    images: string[];
    publishDate: number;
    readTime: number;
    author: string;
    tags?: string[];
    views?: number;
    comments?: number;
  };
  categoryName: string;
  categorySlug: string;
  content?: string;
}

const { article, categoryName, categorySlug, content = '' } = Astro.props;

const siteUrl = 'https://soosanmotor.com';
const currentPath = Astro.url.pathname;
const canonicalUrl = `${siteUrl}${currentPath}`;
const publishedDate = new Date(article.publishDate).toISOString();

const title = `${article.title} | Blog soosanmotor.com`;
const description = article.description;

// Robots directive
const robotsContent = 'index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1';

// Get all products for order notifications
const allProducts = await getCollection('products');
const productsForNotifications = allProducts
  .filter(p => !p.data.isHidden)
  .map(p => ({
    name: p.data.name,
    type: p.data.type,
    slug: p.data.slug
  }));
---

<!DOCTYPE html>
<html lang="vi">
  <head>
    <!-- Primary Meta Tags -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <meta name="description" content={description} />
    
    <!-- Robots & Crawlers -->
    <meta name="robots" content={robotsContent} />
    <meta name="googlebot" content={robotsContent} />
    <meta name="bingbot" content={robotsContent} />
    
    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalUrl} />
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    
    <!-- Language & Regional -->
    <meta http-equiv="Content-Language" content="vi" />
    <meta name="language" content="Vietnamese" />
    <meta name="geo.region" content="VN" />
    <meta name="geo.placename" content="Vietnam" />
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#dc2626" />
    <meta name="msapplication-TileColor" content="#dc2626" />
    
    <!-- Open Graph & Twitter Cards -->
    <SocialMeta 
      title={title}
      description={description}
      image={article.images[0] || '/og-default.jpg'}
      url={currentPath}
      type="article"
      publishedTime={publishedDate}
      author={article.author}
      section={categoryName}
      tags={article.tags}
    />
    
    <!-- Article Schema.org JSON-LD -->
    <ArticleSchema 
      article={article} 
      categoryName={categoryName} 
      categorySlug={categorySlug}
      content={content}
    />
    
    <!-- Preconnect for Performance -->
    <link rel="preconnect" href="https://cdn.soosanmotor.com" crossorigin />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="dns-prefetch" href="https://cdn.soosanmotor.com" />
    
    <!-- AI Crawlers Meta (GEO) -->
    <meta name="ai-content-declaration" content="human-created" />
    <meta name="generator" content="Astro" />
    
    <!-- Scripts -->
    <script is:inline src="/search-enhanced.js"></script>
  </head>
  <body>
    <slot />

    <!-- Floating widgets: QuickContact + OrderNotification -->
    <FloatingWidgets client:load products={productsForNotifications} />

    <!-- Global search enhancement -->
    <GlobalSearch />
  </body>
</html>
